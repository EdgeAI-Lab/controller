/*
 * lens.c
 *
 *  Created on: 2019年7月30日
 *      Author: wt
 */
#include "lens.h"
#include "tim.h"
#include "drv_uart.h"

int32_t lens_pid_register(struct lens *lens, const char *name)
{
  char motor_name[2][OBJECT_NAME_MAX_LEN] = {0};
  uint8_t name_len;
  int32_t err;

  if (lens == NULL)
    return -WT_INVAL;
  if (lens_find(name) != NULL)
    return -WT_EXISTED;

  object_init(&(lens->parent), Object_Class_Lens, name);

  name_len = strlen(name);

  if (name_len > OBJECT_NAME_MAX_LEN / 2)
  {
    name_len = OBJECT_NAME_MAX_LEN / 2;
  }

  for (int i = 0; i < 2; i++)
  {
    memcpy(&motor_name[i], name, name_len);
  }

  lens->motor[left_motor].encoder_tim_handle = &htim3;
  lens->motor[left_motor].pwm_tim_handle = &htim1;
  lens->motor[left_motor].pwm_channel = TIM_CHANNEL_2;
  lens->motor[left_motor].goto_zp_flag = TRUE;

  lens->motor[right_motor].encoder_tim_handle = &htim5;
  lens->motor[right_motor].pwm_tim_handle = &htim1;
  lens->motor[right_motor].pwm_channel = TIM_CHANNEL_1;
  lens->motor[right_motor].goto_zp_flag = TRUE;

  lens->auto_focus_flag = FALSE;

  memcpy(&motor_name[left_motor][name_len], "_LEFT\0", 6);
  memcpy(&motor_name[right_motor][name_len], "_RIGHT\0", 7);

  for (int i = 0; i < 2; i++)
  {
    err = motor_device_register(&(lens->motor[i]), motor_name[i], 0);
    if (err != WT_OK)
      goto end;
  }

  pid_struct_init(&(lens->motor_pid[left_motor]),  500, 0, 1.5, 0, 0);
  pid_struct_init(&(lens->motor_pid[right_motor]), 500, 0, 1.5, 0, 0);

  return WT_OK;
end:
  object_detach(&(lens->parent));

  return err;
}


lens_t lens_find(const char *name)
{
  struct object *object;

  object = object_find(name, Object_Class_Lens);

  return (lens_t)object;
}

float motor_out;
int32_t lens_execute(struct lens *lens)
{
  if (lens == NULL)
    return -WT_INVAL;

  motor_out = pid_calculate(&(lens->motor_pid[left_motor]), __HAL_TIM_GET_COUNTER(&htim3), lens->motor[left_motor].target);
  motor_device_set_current(&(lens->motor[left_motor]), motor_out);


  motor_out = pid_calculate(&(lens->motor_pid[right_motor]), __HAL_TIM_GET_COUNTER(&htim5), lens->motor[right_motor].target);
  motor_device_set_current(&(lens->motor[right_motor]), motor_out);

  return WT_OK;
}

void lens_set_left_motor_target(int16_t target, struct lens *lens)
{
//	taskENTER_CRITICAL();
	lens->motor[left_motor].target += target;
	VAL_LIMIT(lens->motor[left_motor].target,MOTOR_TARGET_MIN,MOTOR_TARGET_MAX);
//	taskEXIT_CRITICAL();

}

void lens_set_right_motor_target(int16_t target, struct lens *lens)
{
//	taskENTER_CRITICAL();
	lens->motor[right_motor].target  += target;
	VAL_LIMIT(lens->motor[right_motor].target,MOTOR_TARGET_MIN,MOTOR_TARGET_MAX);
//	taskEXIT_CRITICAL();
}


#ifdef NEW_001
/* left motor */
static uint16_t left_motor_table[ENCODER_VALUE_LENGTH][2] ={{29,17700},{30,17790},{31,17800},{32,18383},{33,18966},{34,19549},{35,20132},{36,20715},{37,21300},{38,22047},{39,22794},{40,23541},{41,24290},
		{42,25165},{43,26040},{44,26915},{45,27790},{46,28004},{47,28218},{48,28432},{49,28646},{50,28860},{51,29074},
		{52,29290},{53,29443},{54,29596},{55,29749},{56,29902},{57,30055},{58,30208},{59,30361},{60,30514},{61,30667},
		{62,30820},{63,30973},{64,31126},{65,31290},{66,31504},{67,31718},{68,31932},{69,32146},{70,32360},{71,32574},
		{72,32788},{73,33002},{74,33216},{75,33430},{76,33644},{77,33858},{78,34072},{79,34286},{80,34500},{81,34714},
		{82,34928},{83,35142},{84,35356},{85,35570},{86,35790},{87,35905},{88,36020},{89,36135},{90,36250},{91,36365},
		{92,36480},{93,36595},{94,36710},{95,36825},{96,36940},{97,37055},{98,37170},{99,37285},{100,37400},{101,37515},
		{102,37630},{103,37745},{104,37860},{105,37975},{106,38090},{107,38205},{108,38320},{109,38435},{110,38550},{111,38665},
		{112,38790},{113,38826},{114,38862},{115,38898},{116,38934},{117,38970},{118,39006},{119,39042},{120,39078},{121,39114},
		{122,39150},{123,39186},{124,39222},{125,39258},{126,39294},{127,39330},{128,39366},{129,39402},{130,39438},{131,39474},
		{132,39510},{133,39546},{134,39582},{135,39618},{136,39654},{137,39690},{138,39726},{139,39762},{140,39800},{141,39829},
		{142,39858},{143,39887},{144,39916},{145,39945},{146,39974},{147,40003},{148,40032},{149,40061},{150,40090},{151,40119},
		{152,40148},{153,40177},{154,40206},{155,40235},{156,40264},{157,40293},{158,40322},{159,40351},{160,40380},{161,40409},
		{162,40438},{163,40467},{164,40496},{165,40525},{166,40554},{167,40583},{168,40612},{169,40641},{170,40670},{171,40699},
		{172,40728},{173,40757},{174,40786},{175,40815},{176,40844},{177,40873},{178,40902},{179,40931},{180,40960},{181,40989},
		{182,41018},{183,41047},{184,41076},{185,41105},{186,41134},{187,41163},{188,41192},{189,41221},{190,41290},{191,41315},
		{192,41340},{193,41365},{194,41390},{195,41415},{196,41440},{197,41465},{198,41490},{199,41515},{200,41540},{201,41565},
		{202,41590},{203,41615},{204,41640},{205,41665},{206,41690},{207,41715},{208,41740},{209,41765},{210,41790},{211,41815},
		{212,41840},{213,41865},{214,41890},{215,41915},{216,41940},{217,41965},{218,41990},{219,42015},{220,42040},{221,42065},
		{222,42090},{223,42115},{224,42140},{225,42165},{226,42190},{227,42215},{228,42240},{229,42265},{230,42300},{231,42302},
		{232,42304},{233,42306},{234,42308},{235,42310},{236,42312},{237,42314},{238,42316},{239,42318},{240,42320},{241,42322},
		{242,42324},{243,42326},{244,42328},{245,42330},{246,42332},{247,42334},{248,42336},{249,42338},{250,42340},{251,42342},
		{252,42344},{253,42346},{254,42348},{255,42350},{256,42352},{257,42354},{258,42356},{259,42358},{260,42360},{261,42362},
		{262,42364},{263,42366},{264,42368},{265,42370},{266,42372},{267,42374},{268,42376},{269,42378},{270,42380},{271,42382},
		{272,42384},{273,42386},{274,42388},{275,42390},{276,42392},{277,42394},{278,42396},{279,42398},{280,42400},{281,42402},
		{282,42404},{283,42406},{284,42408},{285,42410},{286,42412},{287,42414},{288,42416},{289,42418},{290,42420},{291,42422},
		{292,42424},{293,42426},{294,42428},{295,42430},{296,42432},{297,42434},{298,42436},{299,42438},{300,42500},{350,42600},{400,42700}};
/* right motor */
static uint16_t right_motor_table[ENCODER_VALUE_LENGTH][2] = {{29,1500},{30,1580},{31,1600},{32,1849},{33,2098},{34,2347},{35,2596},{36,2845},{37,3097},{38,4697},{39,6297},{40,7897},{41,9500},
		{42,10250},{43,11000},{44,11750},{45,12500},{46,12871},{47,13242},{48,13613},{49,13984},{50,14355},{51,14726},
		{52,15100},{53,15292},{54,15484},{55,15676},{56,15868},{57,16060},{58,16252},{59,16444},{60,16636},{61,16828},
		{62,17020},{63,17212},{64,17404},{65,17600},{66,17766},{67,17932},{68,18098},{69,18264},{70,18430},{71,18596},
		{72,18762},{73,18928},{74,19094},{75,19260},{76,19426},{77,19592},{78,19758},{79,19924},{80,20090},{81,20256},
		{82,20422},{83,20588},{84,20754},{85,20920},{86,21100},{87,21234},{88,21368},{89,21502},{90,21636},{91,21770},
		{92,21904},{93,22038},{94,22172},{95,22306},{96,22440},{97,22574},{98,22708},{99,22842},{100,22976},{101,23110},
		{102,23244},{103,23378},{104,23512},{105,23646},{106,23780},{107,23914},{108,24048},{109,24182},{110,24316},{111,24450},
		{112,24600},{113,24635},{114,24670},{115,24705},{116,24740},{117,24775},{118,24810},{119,24845},{120,24880},{121,24915},
		{122,24950},{123,24985},{124,25020},{125,25055},{126,25090},{127,25125},{128,25160},{129,25195},{130,25230},{131,25265},
		{132,25300},{133,25335},{134,25370},{135,25405},{136,25440},{137,25475},{138,25510},{139,25545},{140,25600},{141,25650},
		{142,25700},{143,25750},{144,25800},{145,25850},{146,25900},{147,25950},{148,26000},{149,26050},{150,26100},{151,26150},
		{152,26200},{153,26250},{154,26300},{155,26350},{156,26400},{157,26450},{158,26500},{159,26550},{160,26600},{161,26650},
		{162,26700},{163,26750},{164,26800},{165,26850},{166,26900},{167,26950},{168,27000},{169,27050},{170,27100},{171,27150},
		{172,27200},{173,27250},{174,27300},{175,27350},{176,27400},{177,27450},{178,27500},{179,27550},{180,27600},{181,27650},
		{182,27700},{183,27750},{184,27800},{185,27850},{186,27900},{187,27950},{188,28000},{189,28050},{190,28100},{191,28150},
		{192,28200},{193,28250},{194,28300},{195,28350},{196,28400},{197,28450},{198,28500},{199,28550},{200,28600},{201,28650},
		{202,28700},{203,28750},{204,28800},{205,28850},{206,28900},{207,28950},{208,29000},{209,29050},{210,29100},{211,29150},
		{212,29200},{213,29250},{214,29300},{215,29350},{216,29400},{217,29450},{218,29500},{219,29550},{220,29600},{221,29650},
		{222,29700},{223,29750},{224,29800},{225,29850},{226,29900},{227,29950},{228,30000},{229,30050},{230,30100},{231,30102},
		{232,30104},{233,30106},{234,30108},{235,30110},{236,30112},{237,30114},{238,30116},{239,30118},{240,30120},{241,30122},
		{242,30124},{243,30126},{244,30128},{245,30130},{246,30132},{247,30134},{248,30136},{249,30138},{250,30140},{251,30142},
		{252,30144},{253,30146},{254,30148},{255,30150},{256,30152},{257,30154},{258,30156},{259,30158},{260,30160},{261,30162},
		{262,30164},{263,30166},{264,30168},{265,30170},{266,30172},{267,30174},{268,30176},{269,30178},{270,30180},{271,30182},
		{272,30184},{273,30186},{274,30188},{275,30190},{276,30192},{277,30194},{278,30196},{279,30198},{280,30200},{281,30202},
		{282,30204},{283,30206},{284,30208},{285,30210},{286,30212},{287,30214},{288,30216},{289,30218},{290,30220},{291,30222},
		{292,30224},{293,30226},{294,30228},{295,30230},{296,30232},{297,30234},{298,30236},{299,30238},{300,30300},{350,30400},{400,30500}};
#endif


#ifdef NEW_002
/* left motor */
static uint16_t left_motor_table[ENCODER_VALUE_LENGTH][2] ={{29,12200},{30,12400},{31,12500},{32,13000},{33,13500},{34,14000},{35,14500},{36,15000},{37,15500},{38,16083},{39,16666},{40,17249},{41,17832},
		{42,18415},{43,19000},{44,20000},{45,21000},{46,22000},{47,23000},{48,23307},{49,23614},{50,23921},{51,24228},
		{52,24535},{53,24842},{54,25149},{55,25456},{56,25763},{57,26070},{58,26377},{59,26684},{60,27000},{61,27416},
		{62,27832},{63,28248},{64,28664},{65,29080},{66,29500},{67,29619},{68,29738},{69,29857},{70,29976},{71,30095},
		{72,30214},{73,30333},{74,30452},{75,30571},{76,30690},{77,30809},{78,30928},{79,31047},{80,31166},{81,31285},
		{82,31404},{83,31523},{84,31642},{85,31761},{86,31880},{87,32000},{88,32050},{89,32100},{90,32150},{91,32200},
		{92,32250},{93,32300},{94,32350},{95,32400},{96,32450},{97,32500},{98,32550},{99,32600},{100,32650},{101,32700},
		{102,32750},{103,32800},{104,32850},{105,32900},{106,32950},{107,33000},{108,33050},{109,33100},{110,33150},{111,33200},
		{112,33250},{113,33300},{114,33350},{115,33400},{116,33450},{117,33500},{118,33578},{119,33656},{120,33734},{121,33812},
		{122,33890},{123,33968},{124,34046},{125,34124},{126,34202},{127,34280},{128,34358},{129,34436},{130,34514},{131,34592},
		{132,34670},{133,34748},{134,34826},{135,34904},{136,34982},{137,35060},{138,35138},{139,35216},{140,35294},{141,35372},
		{142,35450},{143,35528},{144,35606},{145,35684},{146,35762},{147,35840},{148,35918},{149,35996},{150,36074},{151,36152},
		{152,36230},{153,36308},{154,36386},{155,36500},{156,36513},{157,36526},{158,36539},{159,36552},{160,36565},{161,36578},
		{162,36591},{163,36604},{164,36617},{165,36630},{166,36643},{167,36656},{168,36669},{169,36682},{170,36695},{171,36708},
		{172,36721},{173,36734},{174,36747},{175,36760},{176,36773},{177,36786},{178,36799},{179,36812},{180,36825},{181,36838},
		{182,36851},{183,36864},{184,36877},{185,36890},{186,36903},{187,36916},{188,36929},{189,36942},{190,36955},{191,36968},
		{192,36981},{193,36994},{194,37007},{195,37020},{196,37033},{197,37046},{198,37059},{199,37072},{200,37085},{201,37098},
		{202,37111},{203,37124},{204,37137},{205,37150},{206,37163},{207,37176},{208,37189},{209,37202},{210,37215},{211,37228},
		{212,37241},{213,37254},{214,37267},{215,37280},{216,37293},{217,37306},{218,37319},{219,37332},{220,37345},{221,37358},
		{222,37371},{223,37384},{224,37397},{225,37410},{226,37423},{227,37436},{228,37449},{229,37462},{230,37475},{231,37500},
		{232,37502},{233,37504},{234,37506},{235,37508},{236,37510},{237,37512},{238,37514},{239,37516},{240,37518},{241,37520},
		{242,37522},{243,37524},{244,37526},{245,37528},{246,37530},{247,37532},{248,37534},{249,37536},{250,37538},{251,37540},
		{252,37542},{253,37544},{254,37546},{255,37548},{256,37550},{257,37552},{258,37554},{259,37556},{260,37558},{261,37560},
		{262,37562},{263,37564},{264,37566},{265,37568},{266,37570},{267,37572},{268,37574},{269,37576},{270,37578},{271,37580},
		{272,37582},{273,37584},{274,37586},{275,37588},{276,37590},{277,37592},{278,37594},{279,37596},{280,37598},{281,37600},
		{282,37602},{283,37604},{284,37606},{285,37608},{286,37610},{287,37612},{288,37614},{289,37616},{290,37618},{291,37620},
		{292,37622},{293,37624},{294,37626},{295,37628},{296,37630},{297,37632},{298,37634},{299,37636},{300,37700},{350,37800},{400,37900}};
/* right motor */
static uint16_t right_motor_table[ENCODER_VALUE_LENGTH][2] = {{29,18700},{30,18900},{31,19000},{32,19333},{33,19666},{34,19999},{35,20332},{36,20665},{37,21000},{38,21750},{39,22500},{40,23250},{41,24000},
		{42,24750},{43,25500},{44,26500},{45,27500},{46,28500},{47,29500},{48,29807},{49,30114},{50,30421},{51,30728},
		{52,31035},{53,31342},{54,31649},{55,31956},{56,32263},{57,32570},{58,32877},{59,33184},{60,33500},{61,33666},
		{62,33832},{63,33998},{64,34164},{65,34330},{66,34500},{67,34595},{68,34690},{69,34785},{70,34880},{71,34975},
		{72,35070},{73,35165},{74,35260},{75,35355},{76,35450},{77,35545},{78,35640},{79,35735},{80,35830},{81,35925},
		{82,36020},{83,36115},{84,36210},{85,36305},{86,36400},{87,36500},{88,36666},{89,36832},{90,36998},{91,37164},
		{92,37330},{93,37496},{94,37662},{95,37828},{96,37994},{97,38160},{98,38326},{99,38492},{100,38658},{101,38824},
		{102,38990},{103,39156},{104,39322},{105,39488},{106,39654},{107,39820},{108,39986},{109,40152},{110,40318},{111,40484},
		{112,40650},{113,40816},{114,40982},{115,41148},{116,41314},{117,41500},{118,41552},{119,41604},{120,41656},{121,41708},
		{122,41760},{123,41812},{124,41864},{125,41916},{126,41968},{127,42020},{128,42072},{129,42124},{130,42176},{131,42228},
		{132,42280},{133,42332},{134,42384},{135,42436},{136,42488},{137,42540},{138,42592},{139,42644},{140,42696},{141,42748},
		{142,42800},{143,42852},{144,42904},{145,42956},{146,43008},{147,43060},{148,43112},{149,43164},{150,43216},{151,43268},
		{152,43320},{153,43372},{154,43424},{155,43500},{156,43532},{157,43564},{158,43596},{159,43628},{160,43660},{161,43692},
		{162,43724},{163,43756},{164,43788},{165,43820},{166,43852},{167,43884},{168,43916},{169,43948},{170,43980},{171,44012},
		{172,44044},{173,44076},{174,44108},{175,44140},{176,44172},{177,44204},{178,44236},{179,44268},{180,44300},{181,44332},
		{182,44364},{183,44396},{184,44428},{185,44460},{186,44492},{187,44524},{188,44556},{189,44588},{190,44620},{191,44652},
		{192,44684},{193,44716},{194,44748},{195,44780},{196,44812},{197,44844},{198,44876},{199,44908},{200,44940},{201,44972},
		{202,45004},{203,45036},{204,45068},{205,45100},{206,45132},{207,45164},{208,45196},{209,45228},{210,45260},{211,45292},
		{212,45324},{213,45356},{214,45388},{215,45420},{216,45452},{217,45484},{218,45516},{219,45548},{220,45580},{221,45612},
		{222,45644},{223,45676},{224,45708},{225,45740},{226,45772},{227,45804},{228,45836},{229,45868},{230,45900},{231,46000},
		{232,46002},{233,46004},{234,46006},{235,46008},{236,46010},{237,46012},{238,46014},{239,46016},{240,46018},{241,46020},
		{242,46022},{243,46024},{244,46026},{245,46028},{246,46030},{247,46032},{248,46034},{249,46036},{250,46038},{251,46040},
		{252,46042},{253,46044},{254,46046},{255,46048},{256,46050},{257,46052},{258,46054},{259,46056},{260,46058},{261,46060},
		{262,46062},{263,46064},{264,46066},{265,46068},{266,46070},{267,46072},{268,46074},{269,46076},{270,46078},{271,46080},
		{272,46082},{273,46084},{274,46086},{275,46088},{276,46090},{277,46092},{278,46094},{279,46096},{280,46098},{281,46100},
		{282,46102},{283,46104},{284,46106},{285,46108},{286,46110},{287,46112},{288,46114},{289,46116},{290,46118},{291,46120},
		{292,46122},{293,46124},{294,46126},{295,46128},{296,46130},{297,46132},{298,46134},{299,46136},{300,46200},{350,46300},{400,46400}};
#endif


void lens_set_motors_target_by_distance(uint16_t distance, struct lens *lens)
{
	uint16_t i = 0;
	if( (distance>300) && (distance<=350) )
	{
		distance = 350;
	}
	else if( distance>350 )
	{
		distance = 400;
	}

	if(distance<=28)
	{
		lens->motor[left_motor].target = left_motor_zp;
		lens->motor[right_motor].target = right_motor_zp;
		return;
	}

	for(i=0; i < ENCODER_VALUE_LENGTH; i++)
	{
		if(left_motor_table[i][0] == distance)
		{
			lens->motor[left_motor].target = left_motor_table[i][1];
			break;
		}
	}

	for(i=0; i < ENCODER_VALUE_LENGTH; i++)
	{
		if(right_motor_table[i][0] == distance)
		{
			lens->motor[right_motor].target = right_motor_table[i][1];
			break;
		}
	}
}
